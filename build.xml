<project name="JCPCDK" default="dist" basedir=".">
	
    <property file="ant.properties"/>

    <property name="debug" value="on" />
    <property name="deprecation" value="on" />
    <property name="optimization" value="off" />

    <property name="cdk.dist" value="${cdk.dir}/dist" />
    <property name="cdk.lib" value="${cdk.dir}/jar" />
    <property name="cdk.devellib" value="${cdk.dir}/develjar" />
	<property name="cdk.metainf" value="${cdk.dir}/src/META-INF" />
    <property name="src" value="src" />
    <property name="lib" value="lib" />
	<property name="dist" value="dist" />
    <property name="dist-classes" value="${dist}/classes" />
	<property name="metainf" value="META-INF" />
	<property name="po-classes" value="po/classes" />

	<property name="growing_list_file" value="${dist}/applet-classes-list.files"/>
	<property name="growing_classpath" value="${dist}/applet-jars-list.files"/>

    <target id="clean" name="clean" description="Removes compiled stuff.">
        <delete dir="${dist}" />
    </target>

	<target id="dist" name="dist" depends="compile-jcp, unjar-libjars, unjar-cdkjars"
            description="Builds the JChemPaint application">
        <jar jarfile="${dist}/jchempaint-${jcp.version}.jar">
            <manifest>
                <attribute name="Main-Class" value="org.openscience.jchempaint.application.JChemPaint"/>
                <section name="org/openscience/jchempaint/">
                    <attribute name="Specification-Title" value="JChemPaint"/>
                    <attribute name="Specification-Version" value="2.2"/>
                    <attribute name="Specification-Vendor" value="The CDK Project"/>
                    <attribute name="Implementation-Title" value="org.openscience.cdk.applications.jchempaint"/>
                    <attribute name="Implementation-Version" value="${jcp.version}"/>
                    <attribute name="Implementation-Vendor" value="The CDK Project"/>
                </section>
            </manifest>
            <fileset dir="${dist-classes}">
                <include name="**/*" />
            </fileset>
            <fileset dir="${cdk.dir}/doc">
                <include name="lgpl.license" />
            </fileset>        	
        </jar>
    </target>

    <target id="unjar-libjars" name="unjar-libjars">
        <unjar dest="${dist-classes}">
            <fileset dir="${cdk.lib}">
            	<includesfile name="${cdk.metainf}/atomtype.libdepends"/>
            	<includesfile name="${cdk.metainf}/builder3d.libdepends"/>
            	<includesfile name="${cdk.metainf}/builder3dtools.libdepends"/>
            	<includesfile name="${cdk.metainf}/charges.libdepends"/>
            	<includesfile name="${cdk.metainf}/control.libdepends"/>
                <includesfile name="${cdk.metainf}/core.libdepends"/>
                <includesfile name="${cdk.metainf}/data.libdepends"/>
            	<includesfile name="${cdk.metainf}/datadebug.libdepends"/>
            	<includesfile name="${cdk.metainf}/dict.libdepends"/>
            	<includesfile name="${cdk.metainf}/diff.libdepends"/>
                <includesfile name="${cdk.metainf}/extra.libdepends"/>
            	<includesfile name="${cdk.metainf}/forcefield.libdepends"/>
            	<includesfile name="${cdk.metainf}/formula.libdepends"/>
            	<includesfile name="${cdk.metainf}/inchi.libdepends"/>
            	<includesfile name="${cdk.metainf}/interfaces.libdepends"/>
                <includesfile name="${cdk.metainf}/io.libdepends"/>
            	<includesfile name="${cdk.metainf}/isomorphism.libdepends"/>
            	<includesfile name="${cdk.metainf}/libiocml.libdepends"/>
            	<includesfile name="${cdk.metainf}/libiomd.libdepends"/>
            	<includesfile name="${cdk.metainf}/nonotify.libdepends"/>
            	<includesfile name="${cdk.metainf}/pcore.libdepends"/>
            	<includesfile name="${cdk.metainf}/pdb.libdepends"/>
            	<includesfile name="${cdk.metainf}/pdbcml.libdepends"/>
            	<includesfile name="${cdk.metainf}/qm.libdepends"/>
                <includesfile name="${cdk.metainf}/qsar.libdepends"/>
            	<includesfile name="${cdk.metainf}/qsaratomic.libdepends"/>
            	<includesfile name="${cdk.metainf}/qsarbond.libdepends"/>
            	<includesfile name="${cdk.metainf}/qsarcml.libdepends"/>
            	<includesfile name="${cdk.metainf}/qsarmolecular.libdepends"/>
            	<includesfile name="${cdk.metainf}/qsarprotein.libdepends"/>
            	<includesfile name="${cdk.metainf}/reaction.libdepends"/>
                <includesfile name="${cdk.metainf}/render.libdepends"/>
            	<includesfile name="${cdk.metainf}/sdg.libdepends"/>
            	<includesfile name="${cdk.metainf}/smarts.libdepends"/>
            	<includesfile name="${cdk.metainf}/smiles.libdepends"/>
                <includesfile name="${cdk.metainf}/standard.libdepends"/>
            </fileset>
        </unjar>
        <unjar dest="${dist-classes}">
            <fileset dir="${lib}">
            	<include name="**/*" />
            </fileset>
        </unjar>
        <delete dir="${dist-classes}/META-INF" />
	 </target>

    <target id="unjar-cdkjars" name="unjar-cdkjars">
	 <unjar dest="${dist-classes}">
            <fileset dir="${cdk.dist}/jar">
                <include name="cdk-atomtype.jar"/>
                <include name="cdk-builder3d.jar"/>
                <include name="cdk-builder3dtools.jar"/>
                <include name="cdk-charges.jar"/>
                <include name="cdk-control.jar"/>
                <include name="cdk-core.jar"/>
                <include name="cdk-datadebug.jar"/>
                <include name="cdk-data.jar"/>
                <include name="cdk-dict.jar"/>
                <include name="cdk-diff.jar"/>
                <include name="cdk-extra.jar"/>
                <include name="cdk-fingerprint.jar"/>
                <include name="cdk-forcefield.jar"/>
                <include name="cdk-formula.jar"/>
                <include name="cdk-inchi.jar"/>
                <include name="cdk-interfaces.jar"/>
                <include name="cdk-io.jar"/>
            	<include name="cdk-ionpot.jar"/>
            	<include name="cdk-isomorphism.jar"/>
                <include name="cdk-libiocml.jar"/>
                <include name="cdk-libiomd.jar"/>
                <include name="cdk-nonotify.jar"/>
                <include name="cdk-pcore.jar"/>
                <include name="cdk-pdbcml.jar"/>
                <include name="cdk-pdb.jar"/>
                <include name="cdk-qm.jar"/>
                <include name="cdk-qsaratomic.jar"/>
                <include name="cdk-qsarbond.jar"/>
                <include name="cdk-qsarionpot.jar"/>
                <include name="cdk-qsar.jar"/>
                <include name="cdk-qsarmolecular.jar"/>
                <include name="cdk-qsarprotein.jar"/>
                <include name="cdk-reaction.jar"/>
                <include name="cdk-render.jar"/>
                <include name="cdk-sdg.jar"/>
                <include name="cdk-smarts.jar"/>
                <include name="cdk-smiles.jar"/>
                <include name="cdk-standard.jar"/>
                <include name="cdk-controlbasic.jar"/>
                <include name="cdk-structgen.jar"/>
                <include name="cdk-valencycheck.jar"/>
                
                <!-- added by MR, new controller/renderer -->
                <include name="cdk-controlawt.jar"/>
                <include name="cdk-controlextra.jar"/>
                <include name="cdk-renderawt.jar"/>
                <include name="cdk-renderbasic.jar"/>
                <include name="cdk-rendercontrol.jar"/>
                <include name="cdk-renderextra.jar"/>
                <include name="cdk-rendersvg.jar"/>
                <include name="cdk-ioformats.jar"/> 


            </fileset>
        </unjar>
        <delete dir="${dist-classes}/META-INF" />
    </target>

    <target id="compile-jcp" name="compile-jcp">
        <!-- TODO check if dist-all in cdk has been done-->
        <echo message="Compiling JChemPaint classes." />
        <mkdir dir="${dist-classes}" />
        <javac srcdir="${src}" destdir="${dist-classes}" optimize="${optimization}"
                nowarn="${nowarn}"
                debug="${debug}" deprecation="${deprecation}" target="1.5" source="1.5">
            <classpath>
                <fileset dir="${cdk.lib}" >
                </fileset>
                <fileset dir="${cdk.devellib}">
                </fileset>
                <fileset dir="${cdk.dist}/jar">
                </fileset>
                <fileset dir="${lib}">
                </fileset>
            </classpath>

         </javac>
    	<copydir dest="${dist-classes}/org/openscience/jchempaint/resources" src="${src}/main/org/openscience/jchempaint/resources"></copydir>
    	<copy todir="${dist-classes}">
    	    <fileset dir="${po-classes}"/>
    	</copy>
   </target>

    <target id="dist-applet" name="dist-applet" depends="build-applet" description="Builds the JChemPaint applet jar files with jarindex">
        <zip destfile="${dist}/jchempaint-applet-${jcp.version}.zip">
            <zipfileset dir="${dist}/jar" includes="jchempaint-applet-*.jar"/>
        	<zipfileset dir="${cdk.dir}/doc" includes="lgpl.license"/>
        </zip>
    </target>

    <target id="dist-applet-signed" name="dist-applet-signed" depends="build-applet" description="Builds the JChemPaint applet jar files with jarindex">
        <signjar destDir=""
            alias="${certificatealias}"
            storepass="${keystorepassphrase}"
            preservelastmodified="true">
            <path>
                <fileset dir=".">
                    <includesfile name="${growing_classpath}"/>
                </fileset>
            </path>
        </signjar>
        <zip destfile="${dist}/jchempaint-applet-${jcp.version}.zip">
            <zipfileset dir="${dist}/jar" includes="jchempaint-applet-*.jar"/>
            <zipfileset dir="${cdk.dir}/doc" includes="lgpl.license"/>
        </zip>
    </target>
    
	<target id="build-applet" name="build-applet" depends="compile-jcp, unjar-libjars, unjar-cdkjars" description="Builds the JChemPaint applet jar files with jarindex">
        <!-- At first jars are packed from file lists -->
        <!-- The file lists are generated from tomcat access log files with unpacked class files (and without jar files) -->
        <!-- cat apache/jakarta-tomcat-5.0.28/logs/localhost_access_log.2005-04-27.txt | awk -v classdir="/jcpapplet/classes/" '$9 != 404 && substr($7,0,length(classdir)) == classdir { print substr($7,length(classdir)+1) }' | sort -->
        <!-- hint: uncomment <Valve className="org.apache.catalina.valves.AccessLogValve" in conf/server.xml to switch on tomcat's access logging -->
        <concat destfile="${growing_list_file}" fixlastline="yes" append="no">org/apache/log4j/**${line.separator}</concat>
        <concat destfile="${growing_list_file}" fixlastline="yes" append="yes">
            <fileset file="${metainf}/applet-core.files"/>
        </concat>
        <concat destfile="${growing_classpath}" fixlastline="no" append="no">${dist}/jar/jchempaint-applet-core.jar${line.separator}</concat>
        <macrodef name="jar-from-list">
            <attribute name="destfile"/>
            <attribute name="includesfile"/>
            <sequential>
                <jar destfile="@{destfile}">
                    <fileset dir="${dist-classes}">
                        <includesfile name="@{includesfile}"/>
                        <excludesfile name="${growing_list_file}"/>
                    </fileset>
                </jar>
                <concat destfile="${growing_list_file}" fixlastline="yes" append="yes">
                    <fileset file="@{includesfile}" />
                </concat>
                <concat destfile="${growing_classpath}" fixlastline="no" append="yes">@{destfile}${line.separator}</concat>
            </sequential>
        </macrodef>
        <macrodef name="jar-from-pattern">
            <attribute name="destfile"/>
            <attribute name="includepattern"/>
            <sequential>
                <jar destfile="@{destfile}">
                    <fileset dir="${dist-classes}">
                        <include name="@{includepattern}"/>
                        <excludesfile name="${growing_list_file}"/>
                    </fileset>
                </jar>
                <concat destfile="${growing_list_file}" fixlastline="yes" append="yes">@{includepattern}${line.separator}</concat>
                <concat destfile="${growing_classpath}" fixlastline="no" append="yes">@{destfile}${line.separator}</concat>
            </sequential>
        </macrodef>

                <!--<echo message="Compiling applet logging tool org/openscience/cdk/tools/LoggingTool.java to ${dist-classes}"/>
                    <delete file="${dist-classes}/org/openscience/cdk/tools/LoggingTool.class"/>
                    <javac srcdir="applet" destdir="${dist-classes}" optimize="${optimization}" debug="${debug}" deprecation="${deprecation}" target="1.3" source="1.3">
                </javac>-->

        <mkdir dir="${dist}/jar" />
        <jar-from-list destfile="${dist}/jar/jchempaint-applet-viewer-opts.jar" includesfile="${metainf}/applet-viewer-opts.files"/>
        <jar-from-list destfile="${dist}/jar/jchempaint-applet-editor.jar" includesfile="${metainf}/applet-editor.files"/>
        <jar-from-list destfile="${dist}/jar/jchempaint-applet-editor-opts.jar" includesfile="${metainf}/applet-editor-opts.files"/>
        <jar-from-list destfile="${dist}/jar/jchempaint-applet-resources-core.jar" includesfile="${metainf}/applet-resources-core.files"/>
        <jar-from-list destfile="${dist}/jar/jchempaint-applet-resources.jar" includesfile="${metainf}/jchempaint.datafiles"/>
        <!-- the following jar files are packed from directory patterns -->
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_config.jar" includepattern="org/openscience/cdk/config/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_dict.jar" includepattern="org/openscience/cdk/dict/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_io.jar" includepattern="org/openscience/cdk/io/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_qsar.jar" includepattern="org/openscience/cdk/qsar/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_iupac.jar" includepattern="org/openscience/cdk/iupac/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_math.jar" includepattern="org/openscience/cdk/math/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_tools.jar" includepattern="org/openscience/cdk/tools/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_structgen.jar" includepattern="org/openscience/cdk/structgen/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_nonotify.jar" includepattern="org/openscience/cdk/nonotify/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_modeling.jar" includepattern="org/openscience/cdk/modeling/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_controller.jar" includepattern="org/openscience/cdk/controller/**"/>

        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar" includepattern="org/openscience/cdk/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience.jar" includepattern="org/openscience/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_3pq.jar" includepattern="org/_3pq/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_apache.jar" includepattern="org/apache/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_omegahat.jar" includepattern="org/omegahat/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_w3c.jar" includepattern="org/w3c/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_fest.jar" includepattern="org/fest/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_jaxen.jar" includepattern="org/jaxen/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_xmlcml.jar" includepattern="org/xmlcml/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org.jar" includepattern="org/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-com_ozten.jar" includepattern="com/ozten/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-Jama.jar" includepattern="Jama/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-jas.jar" includepattern="jas/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-javax_vecmath.jar" includepattern="javax/vecmath/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-nu.jar" includepattern="nu/**"/>
        <!-- the following jar contains all other classes and resources -->
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-others.jar" includepattern="**/*"/>
        <!-- the main jar file is packed from a list, but it must be packed as last file because it contains INDEX.LIST -->
        <jar destfile="${dist}/jar/jchempaint-applet-core.jar" index="true">
            <manifest>
                        <section name="org/openscience/cdk/applications/jchempaint/">
                            <attribute name="Specification-Title" value="JChemPaint"/>
                            <attribute name="Specification-Version" value="1.0"/>
                            <attribute name="Specification-Vendor" value="The CDK Project"/>
                            <attribute name="Implementation-Title" value="org.openscience.cdk"/>
                            <attribute name="Implementation-Version" value="${jcp.version}"/>
                            <attribute name="Implementation-Vendor" value="The CDK Project"/>
                        </section>
                </manifest>
            <fileset dir="${dist-classes}">
                <includesfile name="${metainf}/applet-core.files"/>
                <exclude name="org/apache/log4j/**"/>
            </fileset>
        </jar>
        <exec dir="${dist}/jar" executable="jar" >
             <arg line="i jchempaint-applet-core.jar jchempaint-applet-viewer-opts.jar jchempaint-applet-editor.jar jchempaint-applet-editor-opts.jar jchempaint-applet-resources-core.jar jchempaint-applet-resources.jar jchempaint-applet-org_openscience_cdk_config.jar jchempaint-applet-org_openscience_cdk_controller.jar jchempaint-applet-org_openscience_cdk_modeling.jar jchempaint-applet-org_fest.jar jchempaint-applet-org_jaxen.jar jchempaint-applet-org_xmlcml.jar jchempaint-applet-org_openscience_cdk_dict.jar jchempaint-applet-org_openscience_cdk_io.jar jchempaint-applet-org_openscience_cdk_qsar.jar jchempaint-applet-org_openscience_cdk_iupac.jar jchempaint-applet-org_openscience_cdk_math.jar jchempaint-applet-org_openscience_cdk_tools.jar jchempaint-applet-org_openscience_cdk_structgen.jar jchempaint-applet-org_openscience_cdk_nonotify.jar jchempaint-applet-org_openscience_cdk.jar jchempaint-applet-org_openscience.jar jchempaint-applet-org_3pq.jar jchempaint-applet-org_apache.jar jchempaint-applet-org_omegahat.jar jchempaint-applet-org_w3c.jar jchempaint-applet-org.jar jchempaint-applet-com_ozten.jar jchempaint-applet-Jama.jar jchempaint-applet-jas.jar jchempaint-applet-javax_vecmath.jar jchempaint-applet-nu.jar jchempaint-applet-others.jar" />
        </exec>
    </target>
</project>



