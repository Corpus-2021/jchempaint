<project name="JCPAppletCDK" default="dist-applet" basedir=".">
	<import file="build.xml" />
	<property name="growing_list_file" value="${build}/applet-classes-list.files"/>
	<property name="growing_classpath" value="${build}/applet-jars-list.files"/>
	<!--target id="jcp-only-applet" name="jcp-only-applet" depends="jcp-only, build-applet" description="Builds the JChemPaint applet jar files with jarindex" /-->
	<target id="dist-applet" name="dist-applet" depends="dist-jcp, build-applet" description="Builds the JChemPaint applet jar files with jarindex" />
	<target id="build-applet" name="build-applet" description="Builds the JChemPaint applet jar files with jarindex">
		<!-- At first jars are packed from file lists -->
		<!-- The file lists are generated from tomcat access log files with unpacked class files (and without jar files) -->
		<!-- cat apache/jakarta-tomcat-5.0.28/logs/localhost_access_log.2005-04-27.txt | awk -v classdir="/jcpapplet/classes/" '$9 != 404 && substr($7,0,length(classdir)) == classdir { print substr($7,length(classdir)+1) }' | sort -->
		<!-- hint: uncomment <Valve className="org.apache.catalina.valves.AccessLogValve" in conf/server.xml to switch on tomcat's access logging -->
		<concat destfile="${growing_list_file}" fixlastline="yes" append="no">org/apache/log4j/**${line.separator}</concat>
		<concat destfile="${growing_list_file}" fixlastline="yes" append="yes">
			<fileset file="${metainf}/applet-core.files"/>
		</concat>
		<concat destfile="${growing_classpath}" fixlastline="no" append="no">${dist}/jar/jchempaint-applet-core.jar${line.separator}</concat>
		<macrodef name="jar-from-list">
			<attribute name="destfile"/>
			<attribute name="includesfile"/>
			<sequential>
				<jar destfile="@{destfile}">
					<fileset dir="${appjars.dir}">
						<includesfile name="@{includesfile}"/>
						<excludesfile name="${growing_list_file}"/>
					</fileset>
				</jar>
				<concat destfile="${growing_list_file}" fixlastline="yes" append="yes">
					<fileset file="@{includesfile}" />
				</concat>
				<concat destfile="${growing_classpath}" fixlastline="no" append="yes">@{destfile}${line.separator}</concat>
			</sequential>
		</macrodef>
		<macrodef name="jar-from-pattern">
			<attribute name="destfile"/>
			<attribute name="includepattern"/>
			<sequential>
				<jar destfile="@{destfile}">
					<fileset dir="${appjars.dir}">
						<include name="@{includepattern}"/>
						<excludesfile name="${growing_list_file}"/>
					</fileset>
				</jar>
				<concat destfile="${growing_list_file}" fixlastline="yes" append="yes">@{includepattern}${line.separator}</concat>
				<concat destfile="${growing_classpath}" fixlastline="no" append="yes">@{destfile}${line.separator}</concat>
			</sequential>
		</macrodef>

                <!--<echo message="Compiling applet logging tool org/openscience/cdk/tools/LoggingTool.java to ${appjars.dir}"/>
                	<delete file="${appjars.dir}/org/openscience/cdk/tools/LoggingTool.class"/>
	                <javac srcdir="applet" destdir="${appjars.dir}" optimize="${optimization}" debug="${debug}" deprecation="${deprecation}" target="1.3" source="1.3">
                </javac>-->

		<jar-from-list destfile="${dist}/jar/jchempaint-applet-viewer-opts.jar" includesfile="${metainf}/applet-viewer-opts.files"/>
		<jar-from-list destfile="${dist}/jar/jchempaint-applet-editor.jar" includesfile="${metainf}/applet-editor.files"/>
		<jar-from-list destfile="${dist}/jar/jchempaint-applet-editor-opts.jar" includesfile="${metainf}/applet-editor-opts.files"/>
		<jar-from-list destfile="${dist}/jar/jchempaint-applet-resources.jar" includesfile="${metainf}/jchempaint.application.datafiles"/>
		<!-- the following jar files are packed from directory patterns -->
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_applications_jchempaint.jar" includepattern="org/openscience/cdk/applications/jchempaint/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_applications.jar" includepattern="org/openscience/cdk/applications/**"/>
                <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_config.jar" includepattern="org/openscience/cdk/config/**"
/>
                <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_dict.jar" includepattern="org/openscience/cdk/dict/**"
/>
                <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_io.jar" includepattern="org/openscience/cdk/io/**"
/>
                <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_qsar.jar" includepattern="org/openscience/cdk/qsar/**"
/>
                <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_iupac.jar" includepattern="org/openscience/cdk/iupac/**"
/>
                <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_math.jar" includepattern="org/openscience/cdk/math/**"
/>
                <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_tools.jar" includepattern="org/openscience/cdk/tools/**"
/>
                <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_structgen.jar" includepattern="org/openscience/cdk/structgen/**"
/>
                <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_nonotify.jar" includepattern="org/openscience/cdk/nonotify/**"
/>

		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar" includepattern="org/openscience/cdk/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience.jar" includepattern="org/openscience/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_3pq.jar" includepattern="org/_3pq/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_apache.jar" includepattern="org/apache/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_omegahat.jar" includepattern="org/omegahat/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_w3c.jar" includepattern="org/w3c/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_xmlcml.jar" includepattern="org/xmlcml/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org.jar" includepattern="org/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-com_ozten.jar" includepattern="com/ozten/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-Jama.jar" includepattern="Jama/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-jas.jar" includepattern="jas/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-javax_media.jar" includepattern="javax/media/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-javax_vecmath.jar" includepattern="javax/vecmath/**"/>
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-nu.jar" includepattern="nu/**"/>
		<!-- the following jar contains all other classes and resources -->
		<jar-from-pattern destfile="${dist}/jar/jchempaint-applet-others.jar" includepattern="**/*"/>
		<!-- the main jar file is packed from a list, but it must be packed as last file because it contains INDEX.LIST -->
		<jar destfile="${dist}/jar/jchempaint-applet-core.jar" index="true">
			<manifest>
		                <section name="org/openscience/cdk/applications/jchempaint/">
                		    <attribute name="Specification-Title" value="JChemPaint"/>
		                    <attribute name="Specification-Version" value="1.0"/>
		                    <attribute name="Specification-Vendor" value="The CDK Project"/>
		                    <attribute name="Implementation-Title" value="org.openscience.cdk"/>
                		    <attribute name="Implementation-Version" value="${jcp.version}"/>
		                    <attribute name="Implementation-Vendor" value="The CDK Project"/>
                		</section>
		        </manifest>
			<fileset dir="${appjars.dir}">
				<includesfile name="${metainf}/applet-core.files"/>
				<exclude name="org/apache/log4j/**"/>
			</fileset>
			<!--for unknown reasons, this fails with a "negative seek offset" - could depand on ant version.
			it workd directly via jar. For this, go to dist jar and do
			jar i jchempaint-applet-core.jar jchempaint-applet-viewer-opts.jar jchempaint-applet-editor.jar jchempaint-applet-editor-opts.jar jchempaint-applet-resources.jar jchempaint-applet-org_openscience_cdk_applications_jchempaint.jar jchempaint-applet-org_openscience_cdk_applications.jar jchempaint-applet-org_openscience_cdk_config.jar jchempaint-applet-org_openscience_cdk_dict.jar jchempaint-applet-org_openscience_cdk_io.jar jchempaint-applet-org_openscience_cdk_qsar.jar jchempaint-applet-org_openscience_cdk_iupac.jar jchempaint-applet-org_openscience_cdk_math.jar jchempaint-applet-org_openscience_cdk_tools.jar jchempaint-applet-org_openscience_cdk_structgen.jar jchempaint-applet-org_openscience_cdk_nonotify.jar jchempaint-applet-org_openscience_cdk.jar jchempaint-applet-org_openscience.jar jchempaint-applet-org_3pq.jar jchempaint-applet-org_apache.jar jchempaint-applet-org_omegahat.jar jchempaint-applet-org_w3c.jar jchempaint-applet-org_xmlcml.jar jchempaint-applet-org.jar jchempaint-applet-com_ozten.jar jchempaint-applet-Jama.jar jchempaint-applet-jas.jar jchempaint-applet-javax_media.jar jchempaint-applet-javax_vecmath.jar jchempaint-applet-nu.jar jchempaint-applet-others.jar
			-->
			<!--indexjars>
				<fileset dir=".">
					<includesfile name="${growing_classpath}"/>
				</fileset>
			</indexjars-->
		</jar>
	</target>
	<target id="clean-applet" name="clean-applet" description="Removes applet files.">
		<delete>
			<fileset dir="${dist}/jar/" includes="jchempaint-applet-*.jar" />
			<fileset file="${growing_list_file}"/>
			<fileset file="${growing_classpath}"/>
		</delete>
	</target>
</project>
